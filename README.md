# Image Upload Service (with AppSync, Lambda, S3, Cognito)

This full-stack infrastructure lets users **upload images to S3 securely** using a **presigned URL** generated by a Lambda function, protected behind an **AppSync GraphQL API** with **Cognito authentication**.

---

## Deployment

From your local terminal:

```bash
aws cloudformation deploy \
  --template-file infratemplate.yaml \
  --stack-name ImageUploadStack \
  --capabilities CAPABILITY_NAMED_IAM
```

---

## Auth Flow: Signup & Login (Cognito)

### 1. Signup a user:

```bash
aws cognito-idp sign-up \
  --client-id <YOUR_USER_POOL_CLIENT_ID> \
  --username test@example.com (or any username you want to signup with)\
  --password "AnyPasswprd!" \
  --user-attributes Name=email,Value=test@example.com
```

### 2. Confirm the user password:

```bash
aws cognito-idp admin-set-user-password \
--user-pool-id your_user_pool_id \
--username rafay@test.com --password \ 
<your_password> --permanent
```

### 3. Login to get a token:

```bash
aws cognito-idp initiate-auth \
  --auth-flow USER_PASSWORD_AUTH \
  --client-id <YOUR_USER_POOL_CLIENT_ID> \
  --auth-parameters USERNAME=test@example.com,PASSWORD=TestPass123!
```

This gives you a `IdToken` (JWT) which can be used while querying as:

```
Authorization: <YOUR_ID_TOKEN>
```

---

## Example GraphQL Mutation (AppSync Console)

```graphql
mutation {
  getImageUploadUrl(fileName: "test.jpg", fileType: "image/jpeg") {
    uploadUrl
    key
  }
}
```

**Variables:**

```json
{
  "fileName": "test.jpg",
  "fileType": "image/jpeg"
}
```

**Headers:** (If using Postman or Curl. Or You can login via cognito on Appsync QUery Console)

```json
{
  "Content-Type": "application/json",
  "Authorization": "<Your Cognito IdToken>"
}
```

---

## Testing Checklist

| Test Case                                          | Expected Result                                                          |
| -------------------------------------------------- | ------------------------------------------------------------------------ |
|  Unauthorized calls are blocked                    | `401 Unauthorized` being returned without token                          |
|  Authorized calls return a presigned URL + key          | Returns presigned `uploadUrl` and S3 `key`                               |
|  A PUT to that URL places the image under the correct S3 path` | Image is uploaded to the S3 Bucket                                       |

---

## Uploading Image (Using curl/Postman)

```bash
curl -X PUT "<uploadUrl>" \
  -H "Content-Type: image/jpeg" \
  --upload-file path/to/file
```

---

## According to requirements

- Presigned URLs are valid for **5 minutes**
- All images are stored in:\
  `images/{userId}/{fileName}`
- You **must** use `Authorization` header with the **Cognito IdToken**

